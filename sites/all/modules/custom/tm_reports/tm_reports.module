<?php
/**
 * @file
 * Code for the TM Reports feature.
 */

include_once 'tm_reports.features.inc';

/**
 * Implements hook_views_query_alter().
 */
function tm_reports_views_query_alter(&$view, &$query) {
 if ($view->current_display == 'chapters_report' || $view->current_display == 'chapters_report_export') {
  _tm_reports_views_query_alter_chapter_report($view, $query);
 }

 if ($view->current_display == 'industry_report' || $view->current_display == 'industry_report_export') {
  _tm_reports_views_query_alter_industry_report($view, $query);
 }
}

/**
* Implements hook_views_pre_render().
*/
function tm_reports_views_pre_render(&$view) {
  if ($view->current_display == 'chapters_report' || $view->current_display == 'chapters_report_export') {
    _tm_reports_views_pre_render_chapter_report($view);
  }

  if ($view->current_display == 'industry_report' || $view->current_display == 'industry_report_export') {
    _tm_reports_views_pre_render_industry_report($view);
  }
}

/* Modify chapter report view query */
function _tm_reports_views_query_alter_chapter_report(&$view, &$query) {

  // Rewrite JOIN Date of Last Event and Time Ago (field_data_field_event_date table).
  $join = new views_join;
  $join->construct('field_data_field_event_date', 'field_chapter_node', 'nid', 'entity_id', array(), 'LEFT');
  $join->extra = array(
    array(
        'field' => 'entity_type',
        'value' => 'node',
    ),
    array(
        'field' => 'deleted',
        'value' => '0',
    ),
    array(
        'field' => 'field_event_date_value',
        'operator' => '>=',
        'value' => date('Y-m-d', strtotime('-1 year')),
    ),
    array(
        'field' => 'field_event_date_value',
        'operator' => '<',
        'value' => date('Y-m-d'),
    )   
  );
  $query->add_relationship('field_chapter_node__field_data_field_event_date', $join, 'node');
  
  /* Rewrite community managers JOIN */
  $join = new views_join;
  $join->construct('field_data_field_community_managers', 'node', 'nid', 'entity_id', array(), 'LEFT');
   $join->extra = array(
    array(
        'field' => 'entity_type',
        'value' => 'node',
    ),
    array(
        'field' => 'deleted',
        'value' => '0',
    ),
    /* Add new condition */
    array(
        'field' => 'entity_id',
        'value' => 'field_chapter_node__field_data_field_event_date.entity_id',
    )
  );
  $query->add_relationship('field_data_field_community_managers', $join, 'field_data_field_community_managers');

  /* JOIN next event date */
  $join = new views_join;
  $join->construct('field_data_field_event_date', 'field_chapter_node', 'nid', 'entity_id', array(), 'LEFT');
  $join->extra = array(
    array(
        'field' => 'entity_type',
        'value' => 'node',
    ),
    array(
        'field' => 'deleted',
        'value' => '0',
    ),
    array(
        'field' => 'field_event_date_value',
        'operator' => '>',
        'value' => date('Y-m-d', strtotime('now')),
    )
  );
  $query->add_relationship('field_chapter_node__field_data_field_next_event_date', $join, 'node');
  $query->fields['field_chapter_node__field_data_field_event_date_field_event__3']['table'] = 'field_chapter_node__field_data_field_next_event_date';
  
  /* Add nid field of the next event (need in the link) */
  $query->add_field(null, 'field_chapter_node__field_data_field_next_event_date.entity_id', 'next_event_date_entity_id', array('function' => 'max')); 
}

/* Modify chapter report view pre render */
function _tm_reports_views_pre_render_chapter_report(&$view) {

  // developer: uncomment to reset flag count table
  //_tm_flags_fix_flag_counts();

  // Vars for members counts
  $table = 'flagging';
  $table_alias = 'fl';
  $real_field = 'fid';
  $flag = flag_get_flag('signup', NULL);
  $days_ago_30 = time() - (60 * 60 * 24 * 30); // 30 days ago
  $days_ago_90 = time() - (60 * 60 * 24 * 90); // 90 days ago
  $approved_role = user_role_load_by_name("approved user");

  // Add additional columns for each row
  foreach ($view->result as $i => $result) {

    // CHAPTER ID
    $chapter_id = $view->result[$i]->nid;

    // Last Date format
    if (is_numeric($i) && (!empty($view->result[$i]->field_field_event_date[0]['raw']['value']))) {

      // Change Date format
      $event_date = strtotime($view->result[$i]->field_field_event_date[0]['raw']['value']);
      $formatted_date = date("Y-m-d", $event_date);
      $view->result[$i]->field_field_event_date[0]['rendered']['#markup'] = $formatted_date;
      
      // Link date to event
      $event_nid = $view->result[$i]->field_chapter_node_nid;
      $url = 'node/'.$event_nid;
      $interval = format_interval((time() - $event_date) , 1) . t(' ago');
      $event_time_ago_link = l($interval, $url);
      $view->result[$i]->field_field_event_date_1[0]['rendered']['#markup'] = "<span style='white-space: nowrap;'>" . $event_time_ago_link . "</span>";     
    }

    // Next Date format
    if (is_numeric($i) && (!empty($view->result[$i]->field_field_event_date_3[0]['raw']['value']))) {
      // Change Date format
      $event_date = strtotime($view->result[$i]->field_field_event_date_3[0]['raw']['value']);
      $interval = format_interval(($event_date - time()) , 1);
      $next_event_nid = $view->result[$i]->next_event_date_entity_id;
      $url = 'node/'.$next_event_nid;
      $next_event_link = l($interval, $url);        
      $view->result[$i]->field_field_event_date_3[0]['rendered']['#markup'] = $next_event_link;   
    }

    // NEW MEMBERS PAST 30 DAYS
    $view->field["members_30_days_total"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "members_30_days_total", "New Members (30 Days)");
    // Do a side query to calculate results
    $query_sql = "SELECT COUNT(*) total FROM {flagging} f WHERE f.fid = :fid AND f.entity_type = 'node' AND f.entity_id = :chapter_id AND timestamp >= :time_ago";
    $query = db_query($query_sql, array(':fid' => $flag->fid, ':chapter_id' => $chapter_id, ':time_ago' => $days_ago_30))->fetch();
    $members_30_days_total = $query->total;
    $view->field["members_30_days_total"]->view->result[$i]->members_30_days_total = $query->total;


    // NEW MEMBERS PAST 90 DAYS
    $view->field["members_90_days_total"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "members_90_days_total", "New Members (90 Days)");
    // Do a side query to calculate results
    $query_sql = "SELECT COUNT(*) total FROM {flagging} f WHERE f.fid = :fid AND f.entity_type = 'node' AND f.entity_id = :chapter_id AND timestamp >= :time_ago";
    $query = db_query($query_sql, array(':fid' => $flag->fid, ':chapter_id' => $chapter_id, ':time_ago' => $days_ago_90))->fetch();
    $members_90_days_total = $query->total;
    $view->field["members_90_days_total"]->view->result[$i]->members_90_days_total = $members_90_days_total;


     // MEMBERSHIP GROWTH % PAST 30 DAYS
    $view->field["members_30_days_pct"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "members_30_days_pct", "% Growth (30 Days)");
    // Do a side query to calculate results
    $query_sql = "SELECT COUNT(*) total FROM {flagging} f WHERE f.fid = :fid AND f.entity_type = 'node' AND f.entity_id = :chapter_id AND timestamp < :time_ago";
    $query = db_query($query_sql, array(':fid' => $flag->fid, ':chapter_id' => $chapter_id, ':time_ago' => $days_ago_30))->fetch();
    $members_30_days_ago = $query->total;
    $members_30_days_pct = 0;
    if ($members_30_days_ago > 0) {      
      $members_30_days_pct = round((($members_30_days_total / $members_30_days_ago) * 100), 0);
    }
    $view->field["members_30_days_pct"]->view->result[$i]->members_30_days_pct = $members_30_days_pct;


    // MEMBERSHIP GROWTH % PAST 90 DAYS
    $view->field["members_90_days_pct"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "members_90_days_pct", "% Growth (90 Days)");
    // Do a side query to calculate results
    $query_sql = "SELECT COUNT(*) total FROM {flagging} f WHERE f.fid = :fid AND f.entity_type = 'node' AND f.entity_id = :chapter_id AND timestamp < :time_ago";
    $query = db_query($query_sql, array(':fid' => $flag->fid, ':chapter_id' => $chapter_id, ':time_ago' => $days_ago_90))->fetch();
    $members_90_days_ago = $query->total;
    $members_90_days_pct = 0;
    if ($members_90_days_ago > 0) {      
      $members_90_days_pct = round((($members_90_days_total / $members_90_days_ago) * 100), 0);
    }
    $view->field["members_90_days_pct"]->view->result[$i]->members_90_days_pct = $members_90_days_pct;
    

    // TOTAL MEMBERS
    $view->field["members_total"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "members_total", "Total Members");
    // Do a side query to calculate results
    $query_sql = "SELECT COUNT(*) total FROM {flagging} f WHERE f.fid = :fid AND f.entity_type = 'node' AND f.entity_id = :chapter_id";
    $query = db_query($query_sql, array(':fid' => $flag->fid, ':chapter_id' => $chapter_id))->fetch();
    $members_total = $query->total;
    $view->field["members_total"]->view->result[$i]->members_total = $members_total;


    // TOTAL APPROVED MEMBERS
    $view->field["members_approved_total"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "members_approved_total", "Total Approved");
    // Do a side query to calculate results
    $query_sql = "SELECT COUNT(*) total FROM {flagging} f RIGHT JOIN users_roles ON users_roles.uid = f.uid WHERE users_roles.rid = :role_id AND f.fid = :fid AND f.entity_type = 'node' AND f.entity_id = :chapter_id";
    $query = db_query($query_sql, array(':fid' => $flag->fid, ':chapter_id' => $chapter_id, ':role_id' => $approved_role->rid))->fetch();
    $members_approved_total = $query->total;
    $view->field["members_approved_total"]->view->result[$i]->members_approved_total = $members_approved_total;


    // TOTAL UNAPPROVED MEMBERS
    $view->field["members_unapproved_total"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "members_unapproved_total", "Total Unapproved");
    $members_unapproved_total = $members_total - $members_approved_total;
    $view->field["members_unapproved_total"]->view->result[$i]->members_unapproved_total = $members_unapproved_total;
    

    // % UNAPPROVED MEMBERS
    $view->field["members_unapproved_pct"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "members_unapproved_pct", "% Unapproved");
    $members_unapproved_pct = round((($members_unapproved_total / $members_total) * 100), 0);
    $view->field["members_unapproved_pct"]->view->result[$i]->members_unapproved_pct = $members_unapproved_pct;

  }
}

/* Modify industry report view query */
function _tm_reports_views_query_alter_industry_report(&$view, &$query) {

  $industry_field = array();
  $v = taxonomy_vocabulary_machine_name_load("tm_segments");
  $terms = taxonomy_get_tree($v->vid, 0, 1); // get top level taxonomy
  foreach ($terms as $term) {
    // ie: $industry_field['846'] = 'tid_846';
    $industry_field[$term->tid] = 'tid_' . $term->tid;
  }
  
  foreach ($industry_field as $tid => $field_alias) {
    $join = _tm_reports_add_join_industry($field_alias, $tid);
    $query->add_relationship('th_'.$field_alias, $join, 'field_data_field_segment');
    $query->add_field('th_'.$field_alias, 'tid', $field_alias, array('function' => 'count'));
  }

  /* Add field_count for fix industry count in hook_views_pre_render */
  $query->add_field(null, 'DISTINCT(field_chapter_node.nid)', 'field_count', array('function' => 'count'));
}

/* Modify industry report view pre render */
function _tm_reports_views_pre_render_industry_report(&$view) {

  /* Create custom column for the Industry Segment */
  $table = 'taxonomy_term_hierarchy';
  $table_alias = 'th';
  $real_field = 'tid';

  $industry_field = array();
  $v = taxonomy_vocabulary_machine_name_load("tm_segments");
  $terms = taxonomy_get_tree($v->vid, 0, 1); // get top level taxonomy
  foreach ($terms as $term) {
    // ie: $industry_field['846'] = 'Accommodation';
    $industry_field["tid_" . $term->tid] = $term->name;
  }

  $view->field["total_has_industry_pct"] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, "total_has_industry_pct", "Has Industry Segment (%)");

  /* Count */
  foreach ($industry_field as $field_alias => $label) {
      $view->field[$field_alias] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, $field_alias, $label);  
  }

  /* Percentage */
  foreach ($industry_field as $field_alias => $label) {
      $field_alias .= '_pct';
      $label .= ' (%)'; 
      $view->field[$field_alias] = _tm_reports_add_handler_field_numeric($view, $table, $table_alias, $real_field, $field_alias, $label);        
  }

  // Fix Count for Industry Segment term
  foreach ($view->result as $i => $result) {

    // Step 1. count number of members with a segment
    $members_with_segment = 0;
    foreach ($industry_field as $field_alias => $label) {
      if (is_numeric($i) && (!empty($view->field[$field_alias]->view->result[$i]->$field_alias))) {
        $field_count = ($view->field[$field_alias]->view->result[$i]->field_count);
        $count = ($view->field[$field_alias]->view->result[$i]->$field_alias);
        $count_normalise = ($field_count != 0 ? $count / $field_count : $count);
        $members_with_segment += $count_normalise;     
      }
    }

    // correct field value. note: this is horrible code, but what can we do as we are wrangling with views :(
    $view->result[$i]->users_flagging__field_data_field_segment_field_segment_tid = $members_with_segment;

    // Step 2. Calculate % and update count
    foreach ($industry_field as $field_alias => $label) {
      if (is_numeric($i) && (!empty($view->field[$field_alias]->view->result[$i]->$field_alias))) {
        $field_count = ($view->field[$field_alias]->view->result[$i]->field_count);
        $count = ($view->field[$field_alias]->view->result[$i]->$field_alias);
        $count_normalise = ($field_count != 0 ? $count / $field_count : $count);
        $view->field[$field_alias]->view->result[$i]->$field_alias = $count_normalise;
          
        /* Percentage */
        $field_alias .= '_pct';
        //$total = $view->result[$i]->flag_counts_node_count;
        $pct = round(($count_normalise * 100 / $members_with_segment), 1);
        $view->field[$field_alias]->view->result[$i]->$field_alias = $pct;          
      }
    }

    // Step 3. Update total %
    //$approved_members = $view->field["total_has_industry_pct"]->view->result[$i]->total_has_industry_pct
    $approved_members = $view->result[$i]->flag_counts_node_count;
    $total_has_industry_pct = round($members_with_segment * 100 / $approved_members, 0);
    $view->field["total_has_industry_pct"]->view->result[$i]->total_has_industry_pct = $total_has_industry_pct;

  }
}

/**
* Helper function _tm_reports_add_handler_field_numeric
*/
function _tm_reports_add_handler_field_numeric(&$view, $table, $table_alias, $real_field, $field_alias, $label) {
  $field = new views_handler_field_numeric();
  $field ->field_alias =  $field_alias;
  $field ->aliases =  array();
  $field ->original_value =  NULL;
  $field ->additional_fields =  array();
  $field ->view =  &$view;
  $field ->query =  &$view->query;
  $field ->handler_type =  'field';
  $field ->table_alias =  $table_alias;
  $field ->real_field =  $real_field;
  $field ->relationship =  NULL;
  $field ->options = array(
    'id' => 'count',
    'table' => $table,
    'field' => 'count',
    'relationship' => $table_alias,
    'group_type' => 'group',
    'ui_name' => '',
    'label' => $label,
    'exclude' => FALSE,
    'alter'  => array(
      'alter_text' => FALSE,
      'text' => '',
      'make_link' => FALSE,
      'path' => '',
      'absolute' => FALSE,
      'external' => FALSE,
      'replace_spaces' => FALSE,
      'path_case' => 'none',
      'trim_whitespace' => FALSE,
      'alt' => '',
      'rel' => '',
      'link_class' => '',
      'prefix' => '',
      'suffix' => '',
      'target' => '',
      'nl2br' =>  FALSE,
      'max_length' => '',
      'word_boundary' =>  TRUE,
      'ellipsis' => TRUE,
      'more_link' => FALSE,
      'more_link_text' => '',
      'more_link_path' => '',
      'strip_tags' =>  FALSE,
      'trim' => FALSE,
      'preserve_tags' => '',
      'html' => FALSE,
    ),
    'element_type' => '',
    'element_class' => '',
    'element_label_type' => '',
    'element_label_class' => '',
    'element_label_colon' => TRUE,
    'element_wrapper_type' => '',
    'element_wrapper_class' => '',
    'element_default_classes' => TRUE,
    'empty' => '',
    'hide_empty' => FALSE,
    'empty_zero' => FALSE,
    'hide_alter_empty' => TRUE,
    'set_precision'  => FALSE,
    'precision' =>  0,
    'decimal' => '.',
    'separator' => ',',
    'format_plural' => FALSE,
    'format_plural_singular' => 1,
    'format_plural_plural' => '@count',
    'prefix' => '',
    'suffix' => '',
  );
  
  $field ->definition =  array(
    'handler' => 'views_handler_field_numeric',
    'click sortable' => TRUE,
    'group' => 'Field',
    'title' => $label,
    'help' => '',
  );
  
  $field ->is_handler =  TRUE;
  $field ->table =  $table;
  $field ->field =  $real_field;
  $field ->position = 0;
  
  return $field;
}

/**
 * Helper function _tm_reports_add_handler_field_numeric
 */
function _tm_reports_add_join_industry($field_alias, $tid) {
  $join = new views_join;
  $join->construct('taxonomy_term_hierarchy', 'users_flagging__field_data_field_segment', 'field_segment_tid', 'tid', array(), 'LEFT');
  $join->extra = array(
    array(
        'field' => 'tid',
        'value' => $tid,
    ),
    array(
        'field' => 'parent',
        'value' => $tid,
        'operator' => '=',
    ),
  );
  $join->extra_type = 'OR';
  return $join;
}
