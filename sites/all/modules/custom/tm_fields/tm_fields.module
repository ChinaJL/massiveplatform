<?php
/**
 * @file
 * Drupal needs this blank file.
 */

/**
 * Implement hook_ds_field_info
 */
function tm_fields_ds_fields_info($entity_type) {
  $fields = array();

  $fields['tm_ds_chapter_sticker'] = array(
    'title' => t('Chapter sticker'),
    'field_type' => DS_FIELD_TYPE_FUNCTION,
    'ui_limit' => array('event|*', 'user|*'),
    'function' => '_tm_chapter_sticker_process'
  );
  
  $fields['tm_ds_more_actions'] = array(
    'title' => t('More actions'),
    'field_type' => DS_FIELD_TYPE_FUNCTION,
    'ui_limit' => array('*|*'),
    'function' => '_tm_more_actions_process'
  );

  return array($entity_type => $fields);
}
/**
 * Custom function to build the chapter sticker
 */
function _tm_chapter_sticker_process($field, $title = NULL) {
  if (isset($field['entity']->field_chapter['und'][0]['target_id'])) {
    $related_chapter = node_load($field['entity']->field_chapter['und'][0]['target_id']);
    return theme('tm_chapter_sticker', array(
      'chapter_id' => $related_chapter->nid,
      'shortcode' => $related_chapter->field_chapter_shortcode['und'][0]['value'],
      'color' => $related_chapter->field_chapter_color['und'][0]['rgb']
    ));
  }
}
/**
 * Custom function to build the more_actions menu
 */
function _tm_more_actions_process($field, $title = NULL) {
  global $base_root;
  $base = $base_root . request_uri();
  
  $links = array(
    array(
      'wrapper_class' => array('facebook'),
      'content' => l(t('Share on Facebook'), 'https://www.facebook.com/sharer/sharer.php', array(
        'absolute' => TRUE,
        'query' => array('u' => $base),
        'attributes' => array(
          'target' => '_blank',
          'class' => array('facebook'),
          'title' => t('Share this on Facebook')
        )
      ))
    ),

    array(
      'wrapper_class' => array('twitter'),
      'content' => l(t('Share on Twitter'), 'https://twitter.com/share', array(
        'absolute' => TRUE,
        'query' => array('url' => $base),
        'attributes' => array(
          'target' => '_blank',
          'class' => array('twitter'),
          'title' => t('Share this on Twitter')
        )
      ))
    ),

    array(
      'wrapper_class' => array('google-plus'),
      'content' => l(t('Share on Google+'), 'https://plus.google.com/share', array(
        'absolute' => TRUE,
        'query' => array('url' => $base),
        'attributes' => array(
          'onclick' => "javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600'); return false;",
          'class' => array('google-plus'),
          'title' => t('Share this on Google+')
        )
      ))
    ),
  );
  return theme('more_actions', array('links' => $links));
}
/**
 * Implement hook_theme()
 */
function tm_fields_theme() {
  return array(
    'tm_chapter_sticker' => array(
      'variables' => array(
        'chapter_id' => NULL,
        'shortcode' => NULL,
        'color' => NULL
      ),
      'path' => drupal_get_path('module','tm_fields') . '/templates/fields',
      'template' => 'tm_chapter_sticker'
    ),
    'more_actions' => array(
      'variables' => array(
        'links' => array()
      ),
      'path' => drupal_get_path('module','tm_fields') . '/templates/fields',
      'template' => 'tm_more_actions'
    )
  );
}

/**
 * Implementation of hook_ctools_plugin_directory().
 */
function tm_fields_ctools_plugin_directory($module, $plugin) {
  if ($module == 'field_validation' && $plugin == 'validator') {
    return 'plugins/' . $plugin;
  }
}