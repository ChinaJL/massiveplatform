<?php
/**
 * @file
 * Code for the TM Base feature.
 */

include_once 'tm_organizations.features.inc';

/*
* Implements hook_menu()
*/
function tm_organizations_menu() {

  $items['node/%node/follow_organization'] = array(
    'title' => 'Follow organization',
    'page callback' => 'tm_organizations_follow_message',
    'page arguments' => array(1),
    'access callback' => 'user_is_logged_in',
    'type' => MENU_CALLBACK,
  );

  return $items;

}

/**
 * Implement hook_ds_field_info()
 */
function tm_organizations_ds_fields_info($entity_type) {
  if ($entity_type != 'node') {
    return;
  }
  $fields = array();

  // sponsor badge
  $fields['tm_ds_tm_sponsor'] = array(
    'title' => t('TM Sponsor'),
    'field_type' => DS_FIELD_TYPE_FUNCTION,
    'ui_limit' => array('organization|full'),
    'function' => '_tm_sponsor'
  );

  // follower message
  $fields['tm_ds_organization_follow_message'] = array(
    'title' => t('Message for Followers'),
    'field_type' => DS_FIELD_TYPE_FUNCTION,
    'ui_limit' => array('organization|*'),
    'function' => 'tm_fields_organization_follow_message',
    'properties' => array(
      'settings' => array(
        'Extra classes' => array(
          'type' => 'textfield',
          'description' => t('Classes for the link')
        )
      )
    )
  );

  // organization stats (followers)
  $fields['tm_ds_organization_stats'] = array(
    'title' => t('Organization Stats'),
    'field_type' => DS_FIELD_TYPE_FUNCTION,
    'ui_limit' => array('organization|*'),
    'function' => '_tm_ds_organization_stats'
  );

  return array($entity_type => $fields);
}

/* Render organization's follower stats */
function _tm_ds_organization_stats($field, $title = NULL) {

  // check if user is flagged
  $node = $field['entity'];
  $nid = $node->nid;

  $followers_text = "Follower";
  $num_followers = tm_organizations_get_num_followers($nid);

  $html = "";
  if ($num_followers > 0) {
    if ($num_followers > 1) { $followers_text = "Followers"; }
    $html = "<div class='tm_stats_container'>";
    $html .= "<a href='/node/" . $nid . "/followers'><span class='tm_stats tm_stats_followers'>" . $num_followers . " <span class='tm_stats_followers_divider'>|</span> " . $followers_text . " </span></a>";
    $html .= "</div>";
  }

  return $html;
}

/**
 * Print an indication that a company is a TM sponsor
 */
function _tm_sponsor($field, $title = NULL) {
  global $conf;
  $flag = flag_get_flag('tm_sponsor');
  if ($flag->is_flagged($field['entity']->nid)) {
    return t('A ' . $conf['tm_site_name']) . ' ' . l('sponsor', 'sponsors') . '';
  }
}

/* 
 * Alters a node on saving to make sure organizations have the owner field set to author
 */
function tm_organizations_node_presave($node){
  
  // make sure we are working on an organization node
  if ($node->type != "organization") { return; }

  // Step 1. See how many owners the organization has
  $num_owners = 0;
  $owned_by_node_creator = false;
  $owner_uid = 0;
  foreach ($node->field_owner[$node->language] as $owner) {

    // get owner uid in case transferring ownership
    if ($num_owners == 0) {
      $owner_uid = $owner['target_id'];
    }
    
    // check if owned by node creator
    if ($owner['target_id'] == $node->uid) {
      $owned_by_node_creator = true;
    }

    $num_owners++;
  }

  // Step 2. If no owner set, then add the node owner
  if ($num_owners == 0){
    $node->field_owner[$node->language][] = array('target_id' => $node->uid);
  }
  
  // Step 3. If not owned by node creator, re-assign ownership
  // Note: disabled for time being, as no audit trail of original creator kept
  /*if ((!$owned_by_node_creator) and ($num_owners > 0)) {

    $new_owner = user_load($owner_uid);
    $first_name = $new_owner->field_user_first_name['und'][0]['value'];
    $last_name = $new_owner->field_user_last_name['und'][0]['value'];

    $message = "Ownership of this profile has been assigned to " . $first_name . " " . $last_name . ".";
    drupal_set_message($message, 'page_notice');
    $node->uid = $owner_uid;
  }*/

}

// Check if the user can create a company
// 
function tm_organizations_check_user_can_create_company($uid) {

  global $conf;
  $account = user_load($uid);

  // Must be an approved user
  if (!in_array("approved user", $account->roles)) {
    return false;
  }

  // Chapter leaders, moderators can always create companies
  if (in_array("chapter leader", $account->roles) or in_array("moderator", $account->roles)) {
    return true;
  }

  // Limit number of companies a user can create
  // Set tm_add_company_limit
  $users_companies = tm_users_get_companies($uid);
  $tm_add_company_limit = 8; // default if not set
  if (isset($conf["tm_add_company_limit"])) {
    $tm_add_company_limit = $conf["tm_add_company_limit"];
  }

  return (sizeof($users_companies) < $tm_add_company_limit);
}


function tm_organizations_preprocess_page(&$variables, $hook) {

  global $user;
  global $conf;

  $default_message = "Discover and connect with other companies in the " . $conf["tm_site_name"] . " network.";

  if (module_exists("tm_search_api")) {
    $default_message = "Find and discover companies in our network with <a href='/search'>" . $conf["tm_site_name"] . " Search</a>.";
  }

  // Don't allow user to exceed limit of adding companies
  if (current_path() == "node/add/organization") {
    if (!tm_organizations_check_user_can_create_company($user->uid)) {
      $message = "Sorry, you've reached the limit of the number of company profiles you can create.";
      drupal_set_message($message, 'page_notice');
      drupal_goto("user/$user->uid/companies");
    }
  }

  // Put a notice to create company accounts on company page
  if (current_path() == "companies") {

    // Ignore anonymous users
    if (!user_is_logged_in()) {
      drupal_set_message($default_message, 'page_notice');
      return;
    }

    // Only a loaded user has values for the fields.
    $loaded = user_load($user->uid);

    // Check if user has created any company profiles
    $user_has_companies = false;
    $query = new EntityFieldQuery();
    $markup = '';
    $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'organization')
      ->propertyCondition('status', NODE_PUBLISHED)
      ->fieldCondition('field_owner', 'target_id', $user->uid, '=');
    $result = $query->execute();

    if (isset($result['node'])) {
      $user_has_companies = true;
    }

    // Check if user has provided a job role
    $job_role = null;
    if (isset($loaded->field_job_role[LANGUAGE_NONE][0]['value'])) {
      $job_role = $loaded->field_job_role[LANGUAGE_NONE][0]['value'];
    }

    // Check if user has provided a job organization
    $job_organization = null;
    if (isset($loaded->field_job_organization[LANGUAGE_NONE][0]['value'])) {
      $job_organization = $loaded->field_job_organization[LANGUAGE_NONE][0]['value'];
    }

    // Don't show message if no role or organizaton set
    if (($job_organization == null) && ($job_role == null)) {
      drupal_set_message($default_message, 'page_notice');
      return;
    }

    // Option 1. Create a message if user already has a company
    if ($user_has_companies) {
      $message = "Discover and connect with other companies in the " . $conf["tm_site_name"] . " network. View " . l(t('your company profiles'), 'user/' . $loaded->uid . "/companies") . "";
      drupal_set_message($message, 'page_notice');
      return;
    }

    // Option 2. Show message to user to add a company profile
    if (!in_array("approved user", $loaded->roles)) { 
      $add_profile_html = "<a href='javascript:void(0)' onclick='document.getElementById(\"pending_approval\").style.display = \"block\";'>company profile</a> (pending approval)";
      } else {
        $add_profile_html = "<a href='/node/add/organization'>company profile</a>";
    }

    // Create a message
    if ($job_organization != null) {
      $message = "Is <strong>" . t($job_organization)  . "</strong> a company or organization? Get discovered by adding a " . $add_profile_html . ".";
    }
    elseif ($job_role != null) {
      $message = "Get your company discovered by adding a " . $add_profile_html . ".";
    }

    // Display message
    $message .= "<div id='pending_approval' style='display: none;'>Your account is currently pending approval by our team. Once we've approved your account, you will be able to add your company profile.</div>";
    drupal_set_message($message, 'page_notice');

  }
  
  // Put a notice to create company accounts on users company page
  // Target page, ie: /user/10447/companies
  $parts = explode("/", current_path());
  if (sizeof($parts) == 3) {
    if (($parts[0] == "user") and ($parts[2] == "companies")) {
      if ($parts[1] == $user->uid) {        
        $add_profile_html = "<a href='/node/add/organization'>company profile</a>";
        $message = "You are managing the following company profiles. ";
        if (!tm_organizations_check_user_can_create_company($user->uid)) {
          $message .= "You cannot add any more company profiles.";
        } else {
          $message .= "Add a new " . $add_profile_html . ".";
        }
        drupal_set_message($message, 'page_notice');
      }
    }
  }

  // Add photo edit js
  if (isset($variables['node'])) {
    tm_organizations_add_photo_edit_js($variables['node']);
  }

}

// Add javascript to show edit photo buttons
function tm_organizations_add_photo_edit_js($node) {

  global $user;
  global $conf;

  // If viewing company profile, 
  if (!(arg(0) == 'node' and is_numeric(arg(1)) and arg(2) == FALSE)) {
    return;
  }

  // Check node type
  if (!isset($node->type)) {
    return;
  }

  // Check node is organization
  if ($node->type != "organization") {
    return;
  }

  // Check if company is managed by user
  $users_companies = tm_users_get_companies($user->uid);
  if (!in_array($node->nid, $users_companies)) {
    return;
  }

  // check if organization has logo and cover images
  $has_profile_image = true; // mandatory field
  $has_cover_image = false;
  if (isset($node->field_image[LANGUAGE_NONE][0]['uri'])) {
    $has_cover_image = ($node->field_image[LANGUAGE_NONE][0]['uri'] != $conf["tm_images_default_field_image"]);
  }

  // add js vars
  drupal_add_js(array('tm_organizations' => array('nid' => $node->nid)), array('type' => 'setting'));
  drupal_add_js(array('tm_organizations' => array('has_profile_image' => $has_profile_image)), array('type' => 'setting'));
  drupal_add_js(array('tm_organizations' => array('has_cover_image' => $has_cover_image)), array('type' => 'setting'));

  // add edit photo js to page
  drupal_add_js(drupal_get_path('module', 'tm_organizations') . '/js/organization-edit-photos.js');

}

// Add a link to sponsors from the companies page
function tm_organizations_views_post_execute(&$view) {

  if ($view->name == 'companies') {
    $view->build_info['title'] = "Companies &middot; <a style='color: red;' href='/sponsors'>Sponsors</a>";
  }

  if ($view->name == 'sponsors') {
    $view->build_info['title'] = "<a href='/companies'>Companies</a> &middot; Sponsors";
  }

}


/*
 * Display follow message for organziations
 */
function tm_fields_organization_follow_message($field) {
  
  if (!user_is_logged_in()) {
    return;
  }

  if ($field['entity']->type == "organization") {

    $node_id = $field['entity']->nid;

    // always render following message 
    // it is hidden on page load and displayed in tm_organizations_preprocess_flag
    $company = node_load($node_id);
    if (isset($company->field_follower_message[LANGUAGE_NONE][0]['value'])) {
      $message = $company->field_follower_message[LANGUAGE_NONE][0]['value'];
      $message = strip_tags(trim($message));
      if ($message != "") {
        return "You are following " . t($company->title) . "<p class='ds-organization-follow-message-insert'>" . $message . "</p>";
      }
    } else {
      return "You are following " . t($company->title);
    }
  }

}

/*
 * Preprocess organization flags
 */
function tm_organizations_preprocess_flag(&$variables) {

  // modify flag to send organization message
  $send_message = _tm_organizations_preprocess_follow_flag($variables);

  // modify flag if message modification not set
  if (!$send_message) {
    _tm_organizations_preprocess_follow_flag_show_messager($variables);
  }

}

/* 
 * Modify flag to show follow message on follow
 */
function _tm_organizations_preprocess_follow_flag_show_messager(&$variables) {

  if (!user_is_logged_in()) {
    return;
  }

  // operate on follow_organizations
  $flag = &$variables['flag'];
  $entity_id = $variables['entity_id'];
  if ($flag->name != "follow_organizations") {
    return;
  }

  // if already following
  // show the .tm-ds-organization-follow-message field
  if ($variables['last_action'] == "flagged") {

    drupal_add_js('
    jQuery(document).ready(function($) {

      // show message
      $( ".tm-ds-organization-follow-message").show();

      // hide when unfollowed
      $( ".flag-follow-organizations .unflag-action").click(function() {
        setTimeout(function() {
          $( ".tm-ds-organization-follow-message" ).slideUp();
        }, 500); 
      }); 

    });
    ', 'inline');
    return;
  }

  // hide follow message when unfollowing
  if ($variables['last_action'] == "unflagged") {

    drupal_add_js('
    jQuery(document).ready(function($) {

      // show when followed
      $( ".flag-follow-organizations .flag-action").click(function() {
        setTimeout(function() {
          $( ".tm-ds-organization-follow-message" ).slideDown();
        }, 500); 
      }); 

    });
    ', 'inline');
  }

}

/* Get count of how many followers a company has */
function tm_organizations_get_num_followers($nid) {

  $flag = flag_get_flag("follow_organizations");
  $query = "SELECT COUNT(*) total FROM {flagging} f WHERE f.fid = :fid AND f.entity_id = :nid AND f.entity_type = 'node'";
  $result = db_query($query, array(':fid' => $flag->fid, ':nid' => $nid))->fetch();
  return $result->total;
}

/* Customize organization edit form */
function tm_organizations_form_alter(&$form, $form_state, $form_id) {
  global $conf;

  // Modify company edit form
  if ($form_id == 'organization_node_form') {
    // friendly url
    $form['field_friendly_url'][LANGUAGE_NONE][0]['value']['#title'] = $conf["tm_field_company_friendly_url_title"];
    $form['field_friendly_url'][LANGUAGE_NONE][0]['value']['#description'] = $conf["tm_field_company_friendly_url_description"];

    // Show additional link fields based on $conf['tm_users_link_fields']
    $all_fields = array('website', 'twitter', 'facebook', 'linkedin', 'instagram', 'youtube', 'vimeo', 'snapchat');
    if (isset($conf["tm_organizations_link_fields"])) {
      $show_link_fields = $conf["tm_organizations_link_fields"];
      foreach ($all_fields as $field) {
        if (!in_array($field, $show_link_fields)) {
          unset($form['field_link_' . $field]); // hide field
        }
      }
    }
  }
  
}

/* Modify organization node content before being displayed */
function tm_organizations_node_view($node, $view_mode, $langcode) {

  if ($node->type != "organization") {
    return;
  }

  // Show additional link fields based on $conf['tm_users_link_fields']
  global $conf;
  $all_fields = array('website', 'twitter', 'facebook', 'linkedin', 'instagram', 'youtube', 'vimeo', 'snapchat');
  if (isset($conf["tm_organizations_link_fields"])) {
    $show_link_fields = $conf["tm_organizations_link_fields"];
    foreach ($all_fields as $field) {
      if (!in_array($field, $show_link_fields)) {
        unset($node->content['field_link_' . $field]); // hide field
      }
    }
  }

}

/* Set default images */
/* Refer to settings.php configuration */
function tm_organizations_preprocess_field(&$variables) {

  global $conf;

  // Check element type
  $element_type = null;
  if (isset($variables['element']['#object']->type)) {
    $element_type = $variables['element']['#object']->type;
  }

  // Only operate on event
  if ($element_type != "organization") {
    return;
  }

  // Replace default cover image
  if ($variables['element']['#field_name'] == 'field_image') {
    $variables['items'][0]['#item']['uri'] = _tm_organizations_get_default_image($variables['items'][0]['#item']['uri'], $variables['element']['#object']->nid);
  }
}

/**
 * Return default cover image
 * If tm_images_default_path is set then return a random image based in node id
 * URL must be in public:// format
 */
function _tm_organizations_get_default_image($default_image_uri, $nid) {

  global $conf;

  if (isset($conf["tm_images_default_path"])) {
    if (($default_image_uri == $conf["tm_images_default_field_image"]) or ($default_image_uri == "")) {
      $cover_files = $conf["tm_images_default_cover_organization"];
      $image_index = $nid % sizeof($cover_files);
      $cover_file = $conf["tm_images_default_path"] . $cover_files[$image_index];
      return $cover_file;
    }
  }

  // no random image, return what we got
  return $default_image_uri;
}


/**
 * Modify follow flag
 * Allow short message to be sent to person followed
 * Must be approved member and not followed previously
 * Return true if we operated on flag, false otherwise
 */
function _tm_organizations_preprocess_follow_flag(&$variables) {

  global $conf;
  global $user;

  // Check feature is turned on
  if (!$conf["tm_following_enable_message_organization"]) {
    return false;
  }

  // Shortcuts
  $flag = $variables['flag'];
  $status = $variables['status'];
  $entity_id = $variables['entity_id'];

  // Check we are logged in
  if (!user_is_logged_in()) { 
    return false;
  }

  // We only want to operate on the flag displayed on the current organization page
  // Not any flags displayed in related company lists, etc
  if (!(($flag->entity_type == 'node') && (arg(1) == $entity_id))) {
    return false;
  }
 
  // Follow organization flag
  if (($flag->name == "follow_organizations") && ($status == "unflagged")) {
   
    // Check we haven't already followed before with follow_organizations_log
    // If we have, user will be able to follow again but there won't be a message
    $flag_log = flag_get_flag('follow_organizations_log', NULL);
    $you_have_followed_them_before = ($flag_log->is_flagged($entity_id, $user->uid));
    if ($you_have_followed_them_before) {
      return;
    }

    // Check user role
    if (!in_array("approved user", $user->roles)) {
      return;
    }

    // Enhance the follow button
    $variables['flag_button_class'] = 'flag-limit follow bttn bttn-secondary bttn-m';
    drupal_add_js('
    jQuery(document).ready(function($) {
      $( ".flag-follow-organizations a.flag" ).unbind("click");
      $( ".flag-follow-organizations a.flag" ).bind("click.confirm", function(event) {
        jq_follow_message_organization(' . $entity_id . ');
        return false;
      });
    });
    ', 'inline');

    return true;
  }

  return false;

}

/* 
 * Follow organization and send message
 */
function tm_organizations_follow_message($following_organization) {

  global $conf;
  global $user;

  $flag = flag_get_flag('follow_organizations', NULL);
  $flag_log = flag_get_flag('follow_organizations_log', NULL);

  // STEP 1. VALIDATION

  // feature turned on
   // Check feature is turned on
  if (!$conf["tm_following_enable_message_organization"]) {
    drupal_set_message("Sorry this feature is not enabled", 'warning');
    drupal_goto(drupal_get_path_alias('node/' . $following_organization->nid));
    return;
  }

  // Must be approved user
  if (!in_array("approved user", $user->roles)) {
    drupal_set_message("Oops, you must be an approved member to perform this action", 'warning');
    drupal_goto(drupal_get_path_alias('node/' . $following_organization->nid));
    return;
  }

  // Check you aren't already following them
  $you_are_following_them = ($flag->is_flagged($following_organization->nid, $user->uid));
  if ($you_are_following_them) {
    drupal_set_message("Oops, you are already following this member", 'warning');
    drupal_goto(drupal_get_path_alias('node/' . $following_organization->nid));
    return;
  }

  // Check you haven't already followed them before (via follow_organizations_log)
  $you_have_followed_them_before = ($flag_log->is_flagged($following_organization->nid, $user->uid));
  if ($you_have_followed_them_before) {
    drupal_set_message("Oops, you have previously followed this organization, message not allowed", 'warning');
    drupal_goto(drupal_get_path_alias('node/' . $following_organization->nid));
    return;
  }

  // STEP 2. VALIDATE MESSAGE

  // Get message
  $send_message = trim($_GET["follow_message"]);
  // Remove links for non-chapter leaders and non-moderators
  if (!in_array("chapter leader", $user->roles) and !in_array("moderator", $user->roles)) {
    $send_message = preg_replace('@((https?://)?([-\w]+\.[-\w\.]+)+\w(:\d+)?(/([-\w/_\.]*(\?\S+)?)?)*)@', '(link removed)', $send_message);
  }

  $send_message_safe = strip_tags($send_message); // remove html
  $send_message_safe = str_replace("__NL__", "<br>", $send_message_safe);
  $send_message_safe = str_replace("\n", "<br>", $send_message_safe); // add line breaks

  // If message too short
  if ((strlen($send_message_safe) < 10) && ($send_message != "")) {
    drupal_set_message("Oops, follow message is too short", 'warning');
    drupal_goto(drupal_get_path_alias('node/' . $following_organization->nid));
    return;
  }

  // If message too long
  if (strlen($send_message_safe) > 200) {
    drupal_set_message("Oops, follow message is too long", 'warning');
    drupal_goto(drupal_get_path_alias('node/' . $following_organization->nid));
    return;
  }

  // STEP 3. SET STATIC VARIABLE FOR NOTIFICATIONS HOOK
  // Set variable
  $hook_static_var_message = &drupal_static("tm_notifications_new_follower_organization_message");
  $hook_static_var_message = $send_message_safe;

  // STEP 4. SET FOLLOW LOG FLAG
  $flag->flag('flag', $following_organization->nid, $user, TRUE);
  $flag_log->flag('flag', $following_organization->nid, $user, TRUE);

  // STEP 5. RETURN USER TO COMPANY PROFILE
  // Note: tm_notifications_new_follower_flag_flag will occur and send recipient a message
  drupal_set_message("You are now following " . t($following_organization->title));
  drupal_goto(drupal_get_path_alias('node/' . $following_organization->nid));

}

